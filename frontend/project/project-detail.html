<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®è¯¦æƒ… - æ€»æ‰¿åŒ… AI è¯„æµ‹ç³»ç»Ÿ</title>

    <!-- Vue 3 Global Build CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- å¼•å…¥ç»Ÿä¸€é…ç½®ç®¡ç† -->
    <script src="../config.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid;
        }

        .status-running {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: #93c5fd;
        }

        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        .table-row-hover {
            transition: all 0.2s ease;
        }

        .table-row-hover:hover {
            background-color: #f8fafc;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <div class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <nav class="flex items-center space-x-4">
                        <a href="frontend_improved.html" class="text-gray-600 hover:text-gray-900 flex items-center gap-1">
                            <i class="ph-bold ph-arrow-left"></i>
                            è¿”å›é¡¹ç›®åˆ—è¡¨
                        </a>
                        <span class="text-gray-400">/</span>
                        <span class="text-gray-900 font-medium">é¡¹ç›®è¯¦æƒ…</span>
                    </nav>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" v-if="!loading && projectInfo">
            <!-- é¡¹ç›®åŸºæœ¬ä¿¡æ¯ -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-2xl font-bold text-gray-900">{{ projectInfo.project_name }}</h1>
<!--                    <button @click="createNewTask" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center gap-2">-->
<!--                        <i class="ph-bold ph-plus-circle"></i>-->
<!--                        åˆ›å»ºæ–°ä»»åŠ¡-->
<!--                    </button>-->
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">é¡¹ç›®ç¼–ç :</span>
                        <span class="ml-2 text-gray-900">{{ projectInfo.project_code || 'æœªè®¾ç½®' }}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">é¡¹ç›®ç»ç†:</span>
                        <span class="ml-2 text-gray-900">{{ projectInfo.epc_manager || 'æœªè®¾ç½®' }}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">é¡¹ç›®æ‰§è¡Œç»ç†:</span>
                        <span class="ml-2 text-gray-900">{{ projectInfo.entrust_manager || 'æœªè®¾ç½®' }}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">æœ€åæ›´æ–°:</span>
                        <span class="ml-2 text-gray-900">{{ projectInfo.last_update || 'æœªçŸ¥' }}</span>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div v-if="projectStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg p-4 border border-gray-200 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">æ€»ä»»åŠ¡æ•°</p>
                            <p class="text-2xl font-bold text-gray-800">{{ projectStats.task_statistics.total_tasks }}</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <i class="ph-bold ph-list-checks text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-4 border border-gray-200 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">è¿è¡Œä¸­</p>
                            <p class="text-2xl font-bold text-blue-600">{{ getRunningTasksCount() }}</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <i class="ph-bold ph-play-circle text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-4 border border-gray-200 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">å·²å®Œæˆ</p>
                            <p class="text-2xl font-bold text-green-600">{{ projectStats.task_statistics.completed_tasks }}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <i class="ph-bold ph-check-circle text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-4 border border-gray-200 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">è¯„æµ‹çŠ¶æ€</p>
                            <p class="text-2xl font-bold text-green-600">æ­£å¸¸</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <i class="ph-bold ph-trend-up text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç­›é€‰å™¨ -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 text-sm font-medium">çŠ¶æ€ç­›é€‰:</label>
                        <select v-model="statusFilter" @change="loadTasks" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="evaluating">è¯„æµ‹ä¸­</option>
                            <option value="completed">å·²å®Œæˆ</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="refreshTasks" class="text-blue-600 text-sm hover:underline flex items-center gap-1">
                            <i class="ph-bold ph-arrows-clockwise" :class="{'animate-spin': loading}"></i>
                            åˆ·æ–°
                        </button>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">ä»»åŠ¡å†å²</h2>
                </div>

                <div v-if="tasks.length === 0" class="p-8 text-center text-gray-400">
                    æš‚æ— ä»»åŠ¡æ•°æ®
                </div>

                <div v-else class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-3 font-medium text-gray-900">ä»»åŠ¡å‘èµ·äºº</th>
                                <th class="p-3 font-medium text-gray-900">çŠ¶æ€</th>
                                <th class="p-3 font-medium text-gray-900">æ€»æ£€æŸ¥é¡¹</th>
                                <th class="p-3 font-medium text-gray-900">é€šè¿‡é¡¹</th>
                                <th class="p-3 font-medium text-gray-900">é€šè¿‡ç‡</th>
                                <th class="p-3 font-medium text-gray-900">æ£€æŸ¥æ—¶é—´</th>
                                <th class="p-3 font-medium text-gray-900 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="task in tasks" :key="task.id" class="border-b table-row-hover">
                                <!-- ä»»åŠ¡å‘èµ·äººåˆ—ï¼Œæ˜¾ç¤ºcheck_person_name -->
                                <td class="p-3 text-gray-600">
                                    <span v-if="task.check_person_name" class="font-medium">{{ task.check_person_name }}</span>
                                    <span v-else class="text-gray-400">æœªè®¾ç½®</span>
                                </td>
                                <td class="p-3">
                                    <span v-if="task.status === 'IDLE'" class="status-badge bg-gray-100 text-gray-600 border-gray-200">å¾…æœº</span>
                                    <span v-else-if="task.status === 'PENDING'" class="status-badge bg-yellow-100 text-yellow-600 border-yellow-200">ç­‰å¾…ä¸­</span>
                                    <span v-else-if="task.status === 'SYNCING'" class="status-badge status-running">
                                        <i class="ph-bold ph-spinner animate-spin"></i> åŒæ­¥ä¸­
                                    </span>
                                    <span v-else-if="task.status === 'EVALUATING'" class="status-badge status-running">
                                        <i class="ph-bold ph-spinner animate-spin"></i> è¯„æµ‹ä¸­
                                    </span>
                                    <span v-else-if="task.status === 'COMPLETED'" class="status-badge bg-green-50 text-green-600 border-green-200">å·²å®Œæˆ</span>
                                    <span v-else-if="task.status === 'ERROR'" class="status-badge bg-red-50 text-red-600 border-red-200">å¼‚å¸¸</span>
                                    <span v-else class="status-badge bg-gray-100 text-gray-600 border-gray-200">{{ task.status }}</span>
                                </td>
                                <td class="p-3 text-gray-600">
                                    <span v-if="task.has_result">{{ task.total_items || 0 }}</span>
                                    <span v-else class="text-gray-400">-</span>
                                </td>
                                <td class="p-3 text-gray-600">
                                    <span v-if="task.has_result">{{ task.passed_items || 0 }}</span>
                                    <span v-else class="text-gray-400">-</span>
                                </td>
                                <td class="p-3">
                                    <span v-if="task.has_result" class="font-medium"
                                          :class="task.pass_rate >= 80 ? 'text-green-600' : 'text-red-600'">
                                        {{ task.pass_rate }}%
                                    </span>
                                    <span v-else class="text-gray-400">-</span>
                                </td>
                                <td class="p-3 text-gray-400">{{ task.updated_at || task.created_at }}</td>
                                <td class="p-3 text-right">
                                    <div class="flex justify-end gap-2">
                                        <button v-if="task.has_result"
                                                @click="viewResult(task.task_id)"
                                                class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                                            <i class="ph-bold ph-file-text"></i> æŸ¥çœ‹ç»“æœ
                                        </button>
<!--                                        <button v-if="['IDLE', 'ERROR', 'COMPLETED'].includes(task.status)"-->
<!--                                                @click="rerunTask(task.task_id)"-->
<!--                                                class="text-green-600 hover:text-green-800 font-medium flex items-center gap-1">-->
<!--                                            <i class="ph-bold ph-arrow-clockwise"></i> é‡æ–°è¿è¡Œ-->
<!--                                        </button>-->
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µ -->
                <div v-if="pagination.total_pages > 1" class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                    <div class="text-sm text-gray-500">
                        æ˜¾ç¤º {{ (pagination.current_page - 1) * pagination.per_page + 1 }} -
                        {{ Math.min(pagination.current_page * pagination.per_page, pagination.total_items) }}
                        é¡¹ï¼Œå…± {{ pagination.total_items }} é¡¹
                    </div>
                    <div class="flex gap-2">
                        <button @click="changePage(pagination.current_page - 1)"
                                :disabled="!pagination.has_prev"
                                class="px-3 py-1 text-sm border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            ä¸Šä¸€é¡µ
                        </button>
                        <button @click="changePage(pagination.current_page + 1)"
                                :disabled="!pagination.has_next"
                                class="px-3 py-1 text-sm border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            ä¸‹ä¸€é¡µ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div v-if="loading" class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <i class="ph-bold ph-spinner animate-spin text-4xl text-blue-600 mb-4"></i>
                <p class="text-gray-600">æ­£åœ¨åŠ è½½é¡¹ç›®è¯¦æƒ…...</p>
            </div>
        </div>

        <!-- åˆ›å»ºæ–°ä»»åŠ¡æ¨¡æ€æ¡† -->
        <div v-if="showCreateTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">åˆ›å»ºæ–°ä»»åŠ¡</h3>
                    <button @click="showCreateTaskModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡IDï¼ˆå¯é€‰ï¼‰</label>
                        <input v-model="newTaskId"
                               type="text"
                               placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆä»»åŠ¡ID"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">ä»»åŠ¡IDç”¨äºæ ‡è¯†ä¸åŒçš„è¯„æµ‹ä»»åŠ¡ï¼Œå»ºè®®ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°</p>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button @click="confirmCreateTask"
                                class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                            åˆ›å»ºä»»åŠ¡
                        </button>
                        <button @click="showCreateTaskModal = false"
                                class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¡®è®¤å¯¹è¯æ¡†æ¨¡æ€æ¡† -->
        <div v-if="showConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex items-center mb-4">
                    <div class="bg-yellow-100 p-2 rounded-full mr-3">
                        <i class="ph-bold ph-warning text-yellow-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">ç¡®è®¤æ“ä½œ</h3>
                </div>
                <p class="text-gray-600 mb-6">{{ confirmMessage }}</p>
                <div class="flex gap-3">
                    <button @click="executeConfirmAction"
                            class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        ç¡®è®¤
                    </button>
                    <button @click="cancelConfirmAction"
                            class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- é€šçŸ¥æ¨¡æ€æ¡† -->
        <div v-if="showNotificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex items-center mb-4">
                    <div v-if="notificationType === 'success'" class="bg-green-100 p-2 rounded-full mr-3">
                        <i class="ph-bold ph-check-circle text-green-600 text-xl"></i>
                    </div>
                    <div v-else-if="notificationType === 'error'" class="bg-red-100 p-2 rounded-full mr-3">
                        <i class="ph-bold ph-x-circle text-red-600 text-xl"></i>
                    </div>
                    <div v-else class="bg-blue-100 p-2 rounded-full mr-3">
                        <i class="ph-bold ph-info text-blue-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">
                        {{ notificationType === 'success' ? 'æ“ä½œæˆåŠŸ' :
                           notificationType === 'error' ? 'æ“ä½œå¤±è´¥' : 'æç¤º' }}
                    </h3>
                </div>
                <p class="text-gray-600 mb-6">{{ notificationMessage }}</p>
                <div class="flex gap-3">
                    <button @click="closeNotification"
                            class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        ç¡®å®š
                    </button>
                </div>
            </div>
        </div>

      </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const loading = ref(true);
                const projectId = ref('');
                const projectInfo = ref(null);
                const projectStats = ref(null);
                const tasks = ref([]);
                const pagination = ref({
                    current_page: 1,
                    total_pages: 0,
                    total_items: 0,
                    per_page: 20,
                    has_next: false,
                    has_prev: false
                });
                const statusFilter = ref('all');

                // æ¨¡æ€æ¡†çŠ¶æ€
                const showCreateTaskModal = ref(false);
                const showConfirmModal = ref(false);
                const showNotificationModal = ref(false);
                const newTaskId = ref('');
                const confirmMessage = ref('');
                const notificationMessage = ref('');
                const notificationType = ref('success'); // success, error, info
                const pendingAction = ref(null);

                // ä½¿ç”¨ç»Ÿä¸€é…ç½®ç®¡ç†
                const API_BASE = window.AppConfig.getApiBase();

                // ä»åç«¯è·å–çš„å¹¶å‘é…ç½®
                const CONFIG = ref({
                    MAX_CONCURRENT_TASKS: 3, // é»˜è®¤å€¼ï¼Œå°†ä»åç«¯æ›´æ–°
                    RUNNING_STATES: ['SYNCING', 'EVALUATING', 'PENDING'], // è¿è¡Œä¸­çš„çŠ¶æ€
                    RERUNNABLE_STATES: ['COMPLETED', 'ERROR', 'IDLE'] // å¯é‡æ–°è¿è¡Œçš„çŠ¶æ€
                });

                // å¹¶å‘çŠ¶æ€ä¿¡æ¯
                const concurrencyStatus = ref({
                    current_count: 0,
                    max_count: 3,
                    available_slots: 3,
                    is_allowed: true,
                    running_tasks: []
                });

                // è·å–URLå‚æ•°
                const getUrlParam = (name) => {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get(name);
                };

                // è·å–å¹¶å‘çŠ¶æ€é…ç½®
                const loadConcurrencyStatus = async () => {
                    console.log('ğŸ”„ å¼€å§‹åŠ è½½å¹¶å‘çŠ¶æ€...');
                    try {
                        const response = await fetch(`${API_BASE}/task/concurrency/status`);
                        console.log('ğŸ“¡ å¹¶å‘çŠ¶æ€APIå“åº”çŠ¶æ€:', response.status);

                        const data = await response.json();
                        console.log('ğŸ“Š å¹¶å‘çŠ¶æ€APIå“åº”æ•°æ®:', data);

                        if (data.code === 0 && data.data) {
                            // æ›´æ–°é…ç½®
                            if (data.data.config) {
                                CONFIG.value = {
                                    MAX_CONCURRENT_TASKS: data.data.config.max_concurrent_tasks,
                                    RUNNING_STATES: data.data.config.running_states,
                                    RERUNNABLE_STATES: data.data.config.rerunnable_states
                                };
                                console.log('âš™ï¸ é…ç½®æ›´æ–°æˆåŠŸ:', CONFIG.value);
                            }

                            // æ›´æ–°çŠ¶æ€
                            concurrencyStatus.value = {
                                current_count: data.data.current_count,
                                max_count: data.data.max_count,
                                available_slots: data.data.available_slots,
                                is_allowed: data.data.is_allowed,
                                running_tasks: data.data.running_tasks || []
                            };

                            console.log('âœ… å¹¶å‘çŠ¶æ€æ›´æ–°æˆåŠŸ:', concurrencyStatus.value);
                        } else {
                            console.error('âŒ è·å–å¹¶å‘çŠ¶æ€å¤±è´¥:', data.message);
                            // è®¾ç½®é»˜è®¤å€¼
                            concurrencyStatus.value = {
                                current_count: 0,
                                max_count: 3,
                                available_slots: 3,
                                is_allowed: true,
                                running_tasks: []
                            };
                        }
                    } catch (error) {
                        console.error('âŒ è·å–å¹¶å‘çŠ¶æ€ç½‘ç»œå¤±è´¥:', error);
                        // è®¾ç½®é»˜è®¤å€¼
                        concurrencyStatus.value = {
                            current_count: 0,
                            max_count: 3,
                            available_slots: 3,
                            is_allowed: true,
                            running_tasks: []
                        };
                    }
                };

                // è·å–å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æ•°é‡ï¼ˆä½¿ç”¨åç«¯æ•°æ®ï¼‰
                const getRunningTasksCount = () => {
                    return concurrencyStatus.value.current_count;
                };

                // è·å–æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨ï¼ˆä½¿ç”¨åç«¯æ•°æ®ï¼‰
                const getRunningTasks = () => {
                    return concurrencyStatus.value.running_tasks;
                };

                // åŠ è½½é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯
                const loadProjectStats = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/projects/${projectId.value}/stats`);
                        const data = await response.json();
                        if (data.code === 0) {
                            projectStats.value = data.data;
                        } else {
                            console.error('è·å–é¡¹ç›®ç»Ÿè®¡å¤±è´¥:', data.message);
                        }
                    } catch (error) {
                        console.error('è·å–é¡¹ç›®ç»Ÿè®¡å¤±è´¥:', error);
                    }
                };

                // åŠ è½½ä»»åŠ¡åˆ—è¡¨
                const loadTasks = async (page = 1) => {
                    try {
                        const params = new URLSearchParams({
                            page: page,
                            per_page: pagination.value.per_page
                        });

                        if (statusFilter.value && statusFilter.value !== 'all') {
                            params.append('status', statusFilter.value);
                        }

                        const response = await fetch(`${API_BASE}/projects/${projectId.value}/tasks?${params}`);
                        const data = await response.json();

                        if (data.code === 0) {
                            tasks.value = data.data.tasks;
                            pagination.value = data.data.pagination;
                            if (!projectInfo.value) {
                                projectInfo.value = data.data.project;
                            }
                        } else {
                            console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', data.message);
                        }
                    } catch (error) {
                        console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                    }
                };

                // åˆ·æ–°æ•°æ®
                const refreshTasks = async () => {
                    await Promise.all([
                        loadProjectStats(),
                        loadTasks(pagination.value.current_page),
                        loadConcurrencyStatus()
                    ]);
                };

                // åˆ†é¡µ
                const changePage = (newPage) => {
                    if (newPage >= 1 && newPage <= pagination.value.total_pages) {
                        loadTasks(newPage);
                    }
                };

                
                // é‡æ–°è¿è¡Œä»»åŠ¡
                const rerunTask = async (taskId) => {
                    // å…ˆæ£€æŸ¥ä»»åŠ¡çŠ¶æ€
                    const task = tasks.value.find(t => t.task_id === taskId);
                    if (!task) {
                        showNotification('æœªæ‰¾åˆ°è¯¥ä»»åŠ¡ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚', 'error');
                        return;
                    }

                    // è®°å½•å½“å‰çŠ¶æ€ç”¨äºè°ƒè¯•
                    console.log(`å°è¯•é‡æ–°è¿è¡Œä»»åŠ¡ ${taskId}ï¼Œå½“å‰çŠ¶æ€: ${task.status}`);

                    // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œä¸­
                    if (CONFIG.value.RUNNING_STATES.includes(task.status)) {
                        const statusText = {
                            'SYNCING': 'æ­£åœ¨åŒæ­¥æ–‡ä»¶',
                            'EVALUATING': 'æ­£åœ¨è¯„æµ‹ä¸­',
                            'PENDING': 'æ­£åœ¨ç­‰å¾…å¤„ç†'
                        }[task.status] || 'æ­£åœ¨è¿è¡Œ';

                        showNotification(`è¯¥ä»»åŠ¡${statusText}ï¼Œè¯·ç­‰å¾…å½“å‰ä»»åŠ¡å®Œæˆåå†è¯•ã€‚`, 'error');
                        return;
                    }

                    // ä½¿ç”¨åç«¯æ•°æ®è¿›è¡Œå¹¶å‘æ£€æŸ¥
                    if (!concurrencyStatus.value.is_allowed) {
                        const runningTaskIds = concurrencyStatus.value.running_tasks.map(t => t.task_id).join(', ');
                        showNotification(
                            `å½“å‰å·²è¾¾åˆ°æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°é™åˆ¶ï¼ˆ${concurrencyStatus.value.max_count}ä¸ªï¼‰ã€‚\næ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼š${runningTaskIds}\nè¯·ç­‰å¾…éƒ¨åˆ†ä»»åŠ¡å®Œæˆåå†è¯•ã€‚`,
                            'error'
                        );
                        return;
                    }

                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥é‡æ–°è¿è¡Œ
                    if (!CONFIG.value.RERUNNABLE_STATES.includes(task.status)) {
                        showNotification(`å½“å‰ä»»åŠ¡çŠ¶æ€ä¸º"${task.status}"ï¼Œæ— æ³•é‡æ–°è¿è¡Œã€‚`, 'error');
                        return;
                    }

                    // å¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼Œæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                    console.log(`ä»»åŠ¡ ${taskId} çŠ¶æ€æ£€æŸ¥é€šè¿‡ï¼Œå‡†å¤‡å¯åŠ¨`);
                    confirmMessage.value = `ç¡®å®šè¦é‡æ–°è¿è¡Œä»»åŠ¡ "${taskId}" å—ï¼Ÿ\nå½“å‰çŠ¶æ€ï¼š${task.status}\nå½“å‰è¿è¡Œä»»åŠ¡ï¼š${concurrencyStatus.value.current_count}/${concurrencyStatus.value.max_count}`;
                    pendingAction.value = () => executeRerunTask(taskId);
                    showConfirmModal.value = true;
                };

                // æ‰§è¡Œé‡æ–°è¿è¡Œä»»åŠ¡
                const executeRerunTask = async (taskId) => {
                    try {
                        // åœ¨å‘é€è¯·æ±‚å‰ï¼Œå…ˆè·å–æœ€æ–°çš„ä»»åŠ¡çŠ¶æ€è¿›è¡Œè°ƒè¯•
                        const currentTask = tasks.value.find(t => t.task_id === taskId);
                        console.log('å‡†å¤‡å¯åŠ¨ä»»åŠ¡:', {
                            taskId,
                            currentStatus: currentTask?.status,
                            allTasks: tasks.value.map(t => ({ id: t.task_id, status: t.status }))
                        });

                        const response = await fetch(`${API_BASE}/start_evaluation`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                project_id: projectId.value,
                                task_id: taskId
                            })
                        });

                        const data = await response.json();
                        console.log('å¯åŠ¨ä»»åŠ¡å“åº”:', data);

                        if (data.code === 200 || data.code === 0) {
                            // æˆåŠŸå“åº”ï¼š200è¡¨ç¤ºæˆåŠŸå¯åŠ¨ï¼Œ0æ˜¯æ—§ç‰ˆæœ¬å…¼å®¹
                            if (data.message && data.message.includes('è¯„æµ‹å·²å¯åŠ¨')) {
                                showNotification('ä»»åŠ¡å·²æˆåŠŸå¯åŠ¨ï¼è¯„æµ‹ç³»ç»Ÿæ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚ã€‚', 'success');
                            } else {
                                showNotification('ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼', 'success');
                            }
                            refreshTasks();
                        } else {
                            // é”™è¯¯å¤„ç†
                            let errorMessage = data.message;
                            let userMessage = '';

                            if (errorMessage.includes('æœªæ‰¾åˆ°')) {
                                userMessage = 'æœªæ‰¾åˆ°ç›¸å…³é¡¹ç›®æˆ–ä»»åŠ¡ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚';
                            } else if (errorMessage.includes('æƒé™')) {
                                userMessage = 'æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚';
                            } else {
                                userMessage = `å¯åŠ¨å¤±è´¥ï¼š${errorMessage}`;
                            }

                            showNotification(userMessage, 'error');
                        }
                    } catch (error) {
                        console.error('å¯åŠ¨ä»»åŠ¡å¤±è´¥:', error);
                        showNotification('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚', 'error');
                    }
                };

                // åˆ›å»ºæ–°ä»»åŠ¡
                const createNewTask = () => {
                    // ä½¿ç”¨åç«¯æ•°æ®è¿›è¡Œå¹¶å‘æ£€æŸ¥
                    if (!concurrencyStatus.value.is_allowed) {
                        const runningTaskIds = concurrencyStatus.value.running_tasks.map(t => t.task_id).join(', ');
                        showNotification(
                            `å½“å‰å·²è¾¾åˆ°æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°é™åˆ¶ï¼ˆ${concurrencyStatus.value.max_count}ä¸ªï¼‰ã€‚\næ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼š${runningTaskIds}\nè¯·ç­‰å¾…éƒ¨åˆ†ä»»åŠ¡å®Œæˆåå†åˆ›å»ºæ–°ä»»åŠ¡ã€‚`,
                            'error'
                        );
                        return;
                    }

                    // å¦‚æœè¿˜æœ‰å¯ç”¨æ§½ä½ï¼Œæ˜¾ç¤ºåˆ›å»ºä»»åŠ¡æ¨¡æ€æ¡†
                    newTaskId.value = '';
                    showCreateTaskModal.value = true;
                };

                // ç¡®è®¤åˆ›å»ºæ–°ä»»åŠ¡
                const confirmCreateTask = () => {
                    const taskId = newTaskId.value.trim() || 'task_' + Date.now();

                    // å†æ¬¡æ£€æŸ¥å¹¶å‘çŠ¶æ€ï¼ˆé˜²æ­¢åœ¨ç”¨æˆ·è¾“å…¥æœŸé—´çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼‰
                    if (!concurrencyStatus.value.is_allowed) {
                        showNotification('å½“å‰å·²è¾¾åˆ°æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°é™åˆ¶ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•ã€‚', 'error');
                        showCreateTaskModal.value = false;
                        return;
                    }

                    showCreateTaskModal.value = false;
                    executeRerunTask(taskId);
                };

                // æŸ¥çœ‹ç»“æœ
                const viewResult = (taskId) => {
                    window.location.href = `ai_pingce_result.html?project_id=${projectId.value}&task_id=${taskId}`;
                };

                // ç¡®è®¤æ“ä½œç›¸å…³
                const executeConfirmAction = () => {
                    if (pendingAction.value) {
                        pendingAction.value();
                    }
                    cancelConfirmAction();
                };

                const cancelConfirmAction = () => {
                    showConfirmModal.value = false;
                    confirmMessage.value = '';
                    pendingAction.value = null;
                };

                // é€šçŸ¥ç›¸å…³æ–¹æ³•
                const showNotification = (message, type = 'success') => {
                    notificationMessage.value = message;
                    notificationType.value = type;
                    showNotificationModal.value = true;
                };

                const closeNotification = () => {
                    showNotificationModal.value = false;
                    notificationMessage.value = '';
                    notificationType.value = 'success';
                };

                // åˆå§‹åŒ–
                onMounted(async () => {
                    projectId.value = getUrlParam('project_id');
                    if (projectId.value) {
                        // å…ˆåŠ è½½å¹¶å‘çŠ¶æ€ï¼Œç¡®ä¿åˆå§‹åŒ–æ­£ç¡®
                        try {
                            await loadConcurrencyStatus();
                            console.log('å¹¶å‘çŠ¶æ€åˆå§‹åŒ–å®Œæˆ:', concurrencyStatus.value);
                        } catch (error) {
                            console.error('å¹¶å‘çŠ¶æ€åˆå§‹åŒ–å¤±è´¥:', error);
                        }

                        // ç„¶ååŠ è½½å…¶ä»–æ•°æ®
                        try {
                            await Promise.all([
                                loadProjectStats(),
                                loadTasks()
                            ]);
                        } catch (error) {
                            console.error('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥:', error);
                        }
                    } else {
                        alert('ç¼ºå°‘é¡¹ç›®IDå‚æ•°');
                        window.location.href = 'frontend_improved.html';
                    }
                    loading.value = false;
                });

                return {
                    loading,
                    projectId,
                    projectInfo,
                    projectStats,
                    tasks,
                    pagination,
                    statusFilter,
                    CONFIG,
                    concurrencyStatus,
                    // æ¨¡æ€æ¡†çŠ¶æ€
                    showCreateTaskModal,
                    showConfirmModal,
                    showNotificationModal,
                    newTaskId,
                    confirmMessage,
                    notificationMessage,
                    notificationType,
                    // æ–¹æ³•
                    loadTasks,
                    refreshTasks,
                    changePage,
                    loadConcurrencyStatus,
                    getRunningTasksCount,
                    getRunningTasks,
                    rerunTask,
                    createNewTask,
                    viewResult,
                    confirmCreateTask,
                    executeConfirmAction,
                    cancelConfirmAction,
                    showNotification,
                    closeNotification
                };
            }
        }).mount('#app');
    </script>
</body>
</html>